var spm=(typeof(spm)=="object")?window.spm:(function(){var p="spm",q=".",j="no",o="item",k="list",e=[],n=[],d,i,m,h;h=document.referrer;var b=navigator.userAgent,c,g,a={jfmore:/_jfmore_(\d\.\d\.\d)/.test(b)?(/android/i.test(b)?"android":"ios"):"",inIos:!!b.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),inAndroid:/(android)/i.test(b),inPc:!/Android|webOS|iphone|ipod|ipad|BlackBerry/i.test(b),inWeixin:!!b.match(/micromessenger/i),browser:{version:(b.match(/.+(?:rv|it|ra|ie)[\/: ]([\d.]+)/)||[0,"0"])[1],safari:/webkit/i.test(b),uc:/Linux/i.test(b),opera:/opera/i.test(b),msie:/msie/i.test(b)&&!/opera/.test(b),mozilla:/mozilla/i.test(b)&&!/(compatible|webkit)/i.test(b)}};c=(function(){var r="";if(a.jfmore){r=a.jfmore}else{if(a.inWeixin){r="weixin"}else{if(a.inPc){r="pc"}else{if(a.inIos){r="ios-h5"}else{if(a.inAndroid){r="android-h5"}}}}}return r})();g=(function(){var t="",r=a.browser;for(var s in r){if(r[s]&&r.hasOwnProperty(s)&&s!="version"){t=s;break}}return t})();var f={get:function(r){return typeof r=="object"?r:document.querySelector(r)},getAll:function(r){return typeof r=="object"?r:document.querySelectorAll(r)},getDir:function(t,s){var r=[],u=t[s];while(u&&u!=document){if(u.nodeType==1){r.push(u)}u=u[s]}return r},createElem:function(r,s){r=document.createElement(r);for(var t in s){r[t]=s[t]}return r},isArray:function(r){return Object.prototype.toString.call(r)==="[object Array]"},format:function(s){if(arguments.length>1){var r=(arguments.length==2&&this.isArray(arguments[1]))?arguments[1]:this.makeArray(arguments).slice(1);this.each(r,function(t,u){u=u==undefined?"":u;s=s.replace(new RegExp("\\{"+t+"\\}","g"),u)})}return s},makeArray:function(r){var t=[],s=r.length;while(s){t[--s]=r[s]}return t},each:function(s,u){s=s||[];for(var t=0,r=s.length;t<r;t++){if(u.call(s[t],t,s[t])==false){break}}},param:function(t){var r=[];for(var s in t||{}){if(t.hasOwnProperty(s)){r.push(s+"="+t[s])}}return r.join("&")},cookie:{set:function(s,r,u){var t;u=u||{};u.K&&(t=new Date,t.setTime(t.getTime()+u.K));document.cookie=s+"="+r+(u.domain?"; domain="+u.domain:"")+("; path="+(u.path||"/"))+(t?"; expires="+t.toGMTString():"")+(u.rb?"; secure":"")},get:function(r){return(r=RegExp("(^| )"+r+"=([^;]*)(;|$)").exec(document.cookie))?r[2]:null}},getQueryValue:function(t,s){if(!s){s=t;t=location.href+""}var u=new RegExp("(^|&|\\?|#)"+s+"=([^&]*)(&|\x24)","");var r=t.match(u);return((r&&r[2]||"").trim()).split("#")[0]},getSiteCode:function(s){var u,t,r="";u=this.getQueryValue(s||"",p);t=u.split(q);if(t[0]!=""&&t[1]!=""){r=t.slice(0,2).join(q)}return r},getPageCode:function(r){var t,s;t=this.getQueryValue(r||"",p);s=t.split(q);return s[2]||""},getPosCode:function(r){var t,s;t=this.getQueryValue(r||"",p);s=t.split(q);return s[3]||""}};function l(){var r=this;if(!(r instanceof l)){return new l()}r.install=function(){var s=null,t=0,v,u,x,w;x=document;u=function(){s&&(clearInterval(s),s=null)};v=function(){if(x.body&&!r._status){w=x.createElement("meta");w.setAttribute("content","always");w.setAttribute("name","referrer");x.head.appendChild(w);u();r._initDebug();r._initPage();r._initSour();r._bindEvent();r._bindBack();r._correctId();r._status=1}};if(x.body){v()}else{s=setInterval(function(){if(t++>100){u();return}v()},20)}};r.debug=function(s,u,t){if(!r.debugMode){return}r.console[s](t?u+" "+t:u)};r.setDebugOn=function(s){r.debugMode=s};r.setPageCode=function(u,v){var t,s=f.get("body");u=r.spmToArr(u);u.length&&(r._data[2]=u.pop());u.length&&(r._data[1]=u.pop());u.length&&(r._data[0]=u.pop());r._data[3]="0";r._data[4]="0";r._data[5]=r.getPVID();t=f.format(r._tmpl.page,r._data);s.setAttribute(r._attr.page,t);s.removeAttribute(r._attr.base);v&&(document.title=v)};r.getPageCode=function(){return r.arrToSpm(r._data)};r.setModuleCode=function(w,v,t){var u=r._data.slice(0),s;w=r.spmToArr(w);if(!w.length){return w}w.length&&(u[3]=w.pop());w.length&&(u[2]=w.pop());w.length&&(u[1]=w.pop());w.length&&(u[0]=w.pop());if(v){t=t||o;t==o&&(u[4]="0");var x=function(){s=f.format(r._tmpl[t],u);if(t=="form"){v.appendChild(f.createElem("input",{name:p,value:s,type:"hidden"}));v.action?(v.action=r.addSpm(v.action,s)):""}v.setAttribute(r._attr[t],s);v.removeAttribute(r._attr.base)};if(/^(a|area)$/.test(v.tagName.toLowerCase())){if(!r._updateLink(v,u,0,"0")){x()}}else{x()}}return u};r.getModuleCode=function(t){var s=r._data.slice(0);s[3]=t;return r.arrToSpm(s)};r.getNumberCode=function(u){var t=r._data.slice(0),s;u=r.spmToArr(u);if(!u.length){return u}u.length&&(t[4]=u.pop());u.length&&(t[3]=u.pop());u.length&&(t[2]=u.pop());u.length&&(t[1]=u.pop());u.length&&(t[0]=u.pop());return r.arrToSpm(t)};r.setElemItem=function(x,y,u,v){var t,w,s="a";t=x.getAttribute(r._attr.base);y[4]=v||t||u;w=f.format(r._tmpl.item,y);t==j&&(w=j);x.setAttribute(r._attr.item,w);x.removeAttribute(r._attr.base);if(x.tagName.toLowerCase()==s){x.setAttribute("href",r.addSpm(x.getAttribute("href"),w))}};r.push=function(s){var t=s.shift();r.install();r[t].apply(r,s)};r.refresh=function(s,t){if(typeof s=="boolean"){t=s;s=""}!s&&(s=document.location.href);if(s.indexOf(p+"=")<0){s=this.addSpm(s,this._data.join(q))}if(t){location.replace(s)}else{document.location.href=s}};r.arrToSpm=function(s){return(s||[]).join(q)};r.spmToArr=function(s){return((s||"")+"").split(q)};r.sliceBefore=function(t,s){return t.indexOf(s)>=0?t.substring(0,t.indexOf(s)):""};r.sliceAfter=function(t,s){return(t.indexOf(s)>=0)?t.substring(t.indexOf(s)+s.length,t.length):""};r.getQueryValue=f.getQueryValue;r.addSpm=function(s,t){var u="",v;t=t||r.getPageCode();v=r.getQueryValue(s,p);if(v){s=s.replace(v,t)}else{u=r.sliceAfter(s,"#");if(u){u="#"+u;s=r.sliceBefore(s,"#")}s+=((s.indexOf("?")>0)?"&":"?")+p+"="+t}return s+u};r.getSource=function(){var t=this,v,w=[],u,s;t.getPVID();v=f.cookie.get(t._SOURKEY);u=f.get("meta[name=channel_source]");if((t._IS_NEW_PVKEY&&!v)||u){s=u?u.getAttribute("content"):"";w=t.spmToArr(t.getQueryValue(p));v=s||w[6]||t.getQueryValue("channel_source")||"";v&&f.cookie.set(t._SOURKEY,v)}(!v&&m)&&f.cookie.set(t._SOURKEY,m);v=v||m;m=v||"";return v||"02000000"};r.getPVID=function(){var s=this,u;var t,v,x,y,w,z;u=f.cookie.get(s._PVKEY);if(!u){s._IS_NEW_PVKEY=true;if(s._domain.test(h)){w=s.spmToArr(s.getQueryValue(p));u=w[5]||""}else{if(a.jfmore){w=s.spmToArr(s.getQueryValue(p));u=w[5]||""}}u=u||i;if(!u){t=new Date();v="";x="0123456789";y=x.length;while(v.length<6){v+=x.substr(Math.floor(Math.random()*y),1)}u=v+""+t.getMonth()+""+t.getDate()+""+t.getHours()}f.cookie.set(s._PVKEY,u)}i=u;return u}}l.prototype={_stSid:null,_status:0,_IS_NEW_PVKEY:false,_PVKEY:"_P_U_V_",_SOURKEY:"S_O_U_R_C_E",_url:"https://"+(document.domain=="m.changyoyo.com"?"m.changyoyo.com/notify":"test-m-stg.ppppoints.com/wxservice")+"/datacenter/ckd",_send:function(r){try{(new Image()).src=this._url+"?"+f.param(r)}catch(s){}},_sendInfo:function(v,u){var r=this,t={},s="login_token";u.action=="click"&&(u.action="02");t.useragent=b;t.jfmore=a.jfmore;t.browser=c+"_"+g+"_"+a.browser.version;t.domain=document.domain;t.iscookie=navigator.cookieEnabled?1:0;t.sid=r.getPVID();t.token=f.cookie.get(s)||"";t.eventType=u.action;t.remark=u.extend||"";t.preSiCode="";t.prePaCode="";t.preMoCode="";t.moCode=0;t.spm=0;t.siCode=r._getSiteCode();t.paCode=r._getPageCode()||0;t.source=r.getSource();t.reserve=document.title||"";if(u.action=="02"){t.moCode=v[3]||0;t.spm=v[4]||0}t.time="";t.preurl=h||"";if(/00|01|page/.test(u.action)){e.length>0&&(t.preurl=e[e.length-1]);t.curUrl=u.url;t.preSiCode=f.getSiteCode(t.curUrl);t.prePaCode=f.getPageCode(t.curUrl);t.preMoCode=f.getPosCode(t.curUrl);if(r._removeSpm(u.url)==r._removeSpm(e[e.length-1])){return}e.push(u.url);n.push(spm.addSpm(u.url));d=new Date().getTime()}else{e.length>1&&(t.preurl=e[e.length-2]);t.curUrl=e[e.length-1];t.preSiCode=f.getSiteCode(t.curUrl);t.prePaCode=f.getPageCode(t.curUrl);t.preMoCode=f.getPosCode(t.curUrl);!h&&e.length==1&&(t.preurl="");t.time=new Date().getTime()-d}t.curUrl=encodeURIComponent(t.curUrl);t.preurl=encodeURIComponent(t.preurl);r._send(t)},_domain:/changyoyo.com|ppppoints.com|jflm.com/,_data:["","","","","",""],_attr:{base:"data-spm",type:"data-spm-type",page:"data-spm-page",form:"data-spm-form",list:"data-spm-list",item:"data-spm-item",count:"data-spm-count"},_tmpl:{page:"{0}.{1}.{2}.0.0.{5}",form:"{0}.{1}.{2}.{3}.0.{5}",list:"{0}.{1}.{2}.{3}.0.{5}",item:"{0}.{1}.{2}.{3}.{4}.{5}"},_selector:{link:"a,area",button:"[data-spm]:not(a):not(area)"},_status:0,_initPage:function(){var s=this,r,u,t;r=f.get("body");u=f.get("meta[name="+s._attr.base+"]");s._setSiteCode(u?u.getAttribute("content"):"3.1");s.setPageCode(r?r.getAttribute(s._attr.base):"");t=r?r.getAttribute(s._attr.page):"";if(s._data[0]==""){s.debug("warn","001","页面spm初始化失败： 请在页面<meta>中定义站点ID和站点类型")}else{if(s._data[1]==""){s.debug("warn","401","页面spm初始化失败： 请在页面<meta>或<body>中定义站点ID")}else{if(s._data[2]==""){s.debug("warn","100","页面spm初始化失败： 请在页面<body>中定义页面ID")}else{s.debug("info","100","页面初始化， spm = "+t)}}}},_initSour:function(){var r=this,s=r.getSource();for(var t in r._tmpl){if(r._tmpl.hasOwnProperty(t)){r._tmpl[t]=r._tmpl[t]+"."+s}}r._data[6]=s},_bindEvent:function(){var H=this,D=window,N=document,M,E,K,v,F,z=350,J,r;var G=0,O=0,L=0,B=0,A=0,u=0,t=0,I=6,C;F="undefined";M="addEventListener";if(typeof(D.ontouchstart)!=F&&D.ontouchstart!=null){E="touchstart";K="touchend";v="touchmove";J=D}else{E="mousedown";K="mouseup";v="";J=N}J[M](E,function(s){G=new Date().getTime();if(s.touches&&s.touches[0]){B=s.touches[0].pageX;A=s.touches[0].pageY}H._execute(s,false);C=false;r=s},false);v&&J[M](v,function(s){C=true},false);J[M](K,function(s){O=new Date().getTime();if(s.touches&&s.touches[0]){u=s.touches[0].pageX;t=s.touches[0].pageY}if(C||O-G>=z){return}H._execute(r,true)},false)},_bindBack:function(){var r=history.go;history.go=function(){n.length&&e.push(n.pop());r.apply(history,arguments)}},_correctId:function(){var r=this,s=function(){r.getSource();r._stSid=setTimeout(function(){s()},1000)};clearTimeout(r._stSid);s()},_execute:function(v,w){var s=this,u=v.target,r,t;while(u&&u.tagName&&(r=u.tagName.toLowerCase())){t=[];if(/^(body|html)$/.test(r)){break}f.each(f.getDir(u,"parentNode"),function(){this.getAttribute(s._attr.base)&&t.push(this)});if(t.length&&(r=="a"||r=="area")){s._updateModContent(t[0])}else{if(t.length&&u.getAttribute(s._attr.base)){s._updateModContent(t[0])}else{if(r=="form"&&u.getAttribute(s._attr.base)){s._updateModContent(u)}else{if(u.getAttribute(s._attr.base)){s._updateItemContent(u)}}}}if(w){if(u.getAttribute(s._attr.item)){s._addClickStat(u)}else{if(r=="a"||r=="area"){s._updateLink(u,s._data,0);s._addClickStat(u)}}}u=u.parentNode}},_addClickStat:function(u){var t,w,r,v,s;t=u.getAttribute(this._attr.item)||j;w=u.getAttribute("data-spm-action")||"02";r=u.getAttribute("data-spm-extend")||"";v=u.lastClickTime||0;s=new Date().getTime();if(t!=j&&s-v>600){this._trackEvent(t,w,r);u.lastClickTime=s}},_trackPageview:function(s){var r=this,t=[];!e.length&&(s=document.URL);if(s&&r.getQueryValue(s,p)){t=r.spmToArr(r.getQueryValue(s,p))}s=s||document.URL;try{r._sendInfo(t,{action:"00",extend:"",url:s});r.debug("info",208,"添加PV统计成功，spm = "+s)}catch(u){r.debug("warn",408,"添加PV统计失败，spm = "+s)}},_trackEvent:function(s,u,w){var r=this,t=r.spmToArr(s);if(t.length<4){t=r.setModuleCode(s)}try{r._sendInfo(t,{action:u,extend:w});r.debug("info",209,"添加点击统计成功，spm = "+s)}catch(v){r.debug("warn",409,"添加点击统计失败，spm = "+s)}},_updateItemContent:function(w){var t=this,s,r;var u=o,v="form";s=w.tagName.toLowerCase();r=w.getAttribute(t._attr.base);if(!r){return}s==v&&(u=v);t.setModuleCode(r,w,u);t.debug("info","元素初始化， spm = "+r)},_updateModContent:function(x){var t=this,s,r,w;var u=k,v="form";s=x.tagName.toLowerCase();r=x.getAttribute(t._attr.base);if(!r){return}t.debug("group","模块初始化， spm = "+r);t.debug("time","初始化耗时");s==v&&(u=v);w=t.setModuleCode(r,x,u);t._updateModLinks(x,w);t._updateModButtons(x,w);t.debug("timeEnd","初始化耗时");t.debug("groupEnd","模块初始化， spm = "+r)},_updateModLinks:function(v,u){var r=this,s,t=0;s=v.getAttribute(r._attr.type)||"child";v.removeAttribute(r._attr.type);if(s=="all"){f.each(v.querySelectorAll(r._selector.link),function(w){r._updateLink(this,u,w+1);t++})}else{if(s=="child"){f.each(v.children,function(w){if(/^(a|area)$/.test(this.tagName.toLowerCase())){r._updateLink(this,u,w+1);t++}})}}v.setAttribute(r._attr.count,t);r.debug("info",203,"共处理 "+t+" 个链接内容")},_updateModButtons:function(u,t){var r=this,s=0;f.each(u.querySelectorAll(r._selector.button),function(v){if(this.getAttribute(r._attr.item)){return}r.setElemItem(this,t,v+1);s++});u.setAttribute(r._attr.count,u.getAttribute(r._attr.count)+"|"+s);r.debug("info",204,"共处理 "+s+" 个按钮内容")},_updateLink:function(y,x,v,w){var t=this,u,s,r;if(y.getAttribute(t._attr.item)){return false}s=document.location.href;u=(y.getAttribute("href")||"").trim();if(!u||/^(#|javascript).?/i.test(u)||u==s){t.debug("info",403,"链接"+u+"不用处理");return false}r=y.getAttribute(t._attr.base);t.setElemItem(y,x,v,w);if(r==j){t.debug("info",403,"链接"+u+"已设置为不需要spm")}else{t.debug("info",403,"链接"+u+"已设置为不需要spm")}return true},_initDebug:function(){this.console=window&&window.console||{};if(!this.console.log){this.console.log=function(){}}if(!this.console.info){this.console.info=function(){}}if(!this.console.warn){this.console.warn=function(){}}if(!this.console.group){this.console.group=function(){}}if(!this.console.groupEnd){this.console.groupEnd=function(){}}if(!this.console.time){this.console.time=function(){}}if(!this.console.timeEnd){this.console.timeEnd=function(){}}},_setSiteCode:function(s){var r=this;s=r.spmToArr(s);s.length&&(r._data[0]=s.shift());s.length&&(r._data[1]=s.shift())},_getSiteCode:function(){return this.arrToSpm(this._data.slice(0,2))},_getPageCode:function(){return this._data[2]},_removeSpm:function(s){var r=this;s=s||"";var u=r.sliceBefore(s,"?");if(!u){return s}var t=r.sliceAfter(s,"?");var v=r.getQueryValue(s,p);t=t.replace(p+"="+v,"");return u+t}};return new l()})();typeof exports==="object"&&typeof module!=="undefined"?module.exports=spm:typeof define==="function"&&define.amd?define(spm):(window.spm=spm);spm.install();
