var spm=(function(){var k="spm",l=".",g="no",j="item",h="list",d=[];var b=navigator.userAgent,c,f,a={jfmore:/_jfmore_(\d\.\d\.\d)/.test(b)?(/android/i.test(b)?"android":"ios"):"",inIos:!!b.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),inAndroid:/(android)/i.test(b),inPc:!/Android|webOS|iphone|ipod|ipad|BlackBerry/i.test(b),inWeixin:!!b.match(/micromessenger/i),browser:{version:(b.match(/.+(?:rv|it|ra|ie)[\/: ]([\d.]+)/)||[0,"0"])[1],safari:/webkit/i.test(b),uc:/Linux/i.test(b),opera:/opera/i.test(b),msie:/msie/i.test(b)&&!/opera/.test(b),mozilla:/mozilla/i.test(b)&&!/(compatible|webkit)/i.test(b)}};c=(function(){var m="";if(a.jfmore){m=a.jfmore}else{if(a.inWeixin){m="weixin"}else{if(a.inPc){m="pc"}else{if(a.inIos){m="ios-h5"}else{if(a.inAndroid){m="android-h5"}}}}}return m})();f=(function(){var o="",m=a.browser;for(var n in m){if(m[n]&&m.hasOwnProperty(n)&&n!="version"){o=n;break}}return o})();var e={get:function(m){return typeof m=="object"?m:document.querySelector(m)},getAll:function(m){return typeof m=="object"?m:document.querySelectorAll(m)},getDir:function(o,n){var m=[],p=o[n];while(p&&p!=document){if(p.nodeType==1){m.push(p)}p=p[n]}return m},createElem:function(m,n){m=document.createElement(m);for(var o in n){m[o]=n[o]}return m},isArray:function(m){return Object.prototype.toString.call(m)==="[object Array]"},format:function(n){if(arguments.length>1){var m=(arguments.length==2&&this.isArray(arguments[1]))?arguments[1]:this.makeArray(arguments).slice(1);this.each(m,function(o,p){p=p==undefined?"":p;n=n.replace(new RegExp("\\{"+o+"\\}","g"),p)})}return n},makeArray:function(m){var o=[],n=m.length;while(n){o[--n]=m[n]}return o},each:function(n,p){n=n||[];for(var o=0,m=n.length;o<m;o++){if(p.call(n[o],o,n[o])==false){break}}},param:function(o){var m=[];for(var n in o||{}){if(o.hasOwnProperty(n)){m.push(n+"="+o[n])}}return m.join("&")},cookie:{set:function(n,m,p){var o;p=p||{};p.K&&(o=new Date,o.setTime(o.getTime()+p.K));document.cookie=n+"="+m+(p.domain?"; domain="+p.domain:"")+(p.path?"; path="+p.path:"")+(o?"; expires="+o.toGMTString():"")+(p.rb?"; secure":"")},get:function(m){return(m=RegExp("(^| )"+m+"=([^;]*)(;|$)").exec(document.cookie))?m[2]:null}},getQueryValue:function(o,n){if(!n){n=o;o=location.search}o=o.indexOf("#")>=0?o.substring(0,o.indexOf("#")):o;var p=new RegExp("(^|&|\\?|#)"+n+"=([^&]*)(&|\x24)","");var m=o.match(p);return(m&&m[2]||"").trim()},getSiteCode:function(n){var p,o,m="";p=this.getQueryValue(n||"",k);o=p.split(l);if(o[0]!=""&&o[1]!=""){m=o.slice(0,2).join(l)}return m},getPageCode:function(m){var o,n;o=this.getQueryValue(m||"",k);n=o.split(l);return n[2]||""},getPosCode:function(m){var o,n;o=this.getQueryValue(m||"",k);n=o.split(l);return n[3]||""}};function i(){var n=this;if(!(n instanceof i)){return new i()}n.install=function(){if(!n._status){n._initDebug();n._initPage();n._bindEvent()}};n.debug=function(m,p,o){if(!n.debugMode){return}n.console[m](o?p+" "+o:p)};n.setDebugOn=function(m){n.debugMode=m};n.setPageCode=function(p){var o,m=e.get("body");p=n.spmToArr(p);p.length&&(n._data[2]=p.pop());p.length&&(n._data[1]=p.pop());p.length&&(n._data[0]=p.pop());n._data[3]="0";n._data[4]="0";n._data[5]=n.getPVID();o=e.format(n._tmpl.page,n._data);m.setAttribute(n._attr.page,o);m.removeAttribute(n._attr.base)};n.getPageCode=function(){return n.arrToSpm(n._data)};n.setModuleCode=function(r,q,o){var p=n._data.slice(0),m;r=n.spmToArr(r);if(!r.length){return r}r.length&&(p[3]=r.pop());r.length&&(p[2]=r.pop());r.length&&(p[1]=r.pop());r.length&&(p[0]=r.pop());if(q){o=o||j;o==j&&(p[4]="0");var s=function(){m=e.format(n._tmpl[o],p);if(o=="form"){q.appendChild(e.createElem("input",{name:k,value:m,type:"hidden"}));q.action?(q.action=n.addSpm(q.action,m)):""}q.setAttribute(n._attr[o],m);q.removeAttribute(n._attr.base)};if(/^(a|area)$/.test(q.tagName.toLowerCase())){if(!n._updateLink(q,p,0,"0")){s()}}else{s()}}return p};n.getModuleCode=function(o){var m=n._data.slice(0);m[3]=o;return n.arrToSpm(m)};n.setElemItem=function(s,t,p,q){var o,r,m="a";o=s.getAttribute(n._attr.base);t[4]=q||o||p;r=e.format(n._tmpl.item,t);o==g&&(r=g);s.setAttribute(n._attr.item,r);s.removeAttribute(n._attr.base);if(s.tagName.toLowerCase()==m){s.setAttribute("href",n.addSpm(s.getAttribute("href"),r))}};n.push=function(m){var o=m.shift();n[o].apply(n,m)};n.refresh=function(m,o){if(typeof m=="boolean"){o=m;m=""}!m&&(m=document.location.href);if(m.indexOf(k+"=")<0){m=this.addSpm(m,this._data.join(l))}if(o){location.replace(m)}else{document.location.href=m}};n.arrToSpm=function(m){return(m||[]).join(l)};n.spmToArr=function(m){return(m||"").split(l)};n.sliceBefore=function(o,m){return o.indexOf(m)>=0?o.substring(0,o.indexOf(m)):""};n.sliceAfter=function(o,m){return(o.indexOf(m)>=0)?o.substring(o.indexOf(m)+m.length,o.length):""};n.getQueryValue=e.getQueryValue;n.addSpm=function(m,o){var p="",q;o=o||n.getPageCode();q=n.getQueryValue(m,k);if(q){m=m.replace(q,o)}else{p=n.sliceAfter(m,"#");if(p){p="#"+p;m=n.sliceBefore(m,"#")}m+=((m.indexOf("?")>0)?"&":"?")+k+"="+o}return m+p};n.getPVID=function(){var m,q,s,u,r;var t="_P_U_V_",o,p;o=e.cookie.get(t);if(!o){p=document.referrer;if(n._domain.test(p)){r=n.spmToArr(n.getQueryValue(k));o=r[5]||""}else{if(a.jfmore){r=n.spmToArr(n.getQueryValue(k));o=r[5]||""}}if(!o){m=new Date();q="";s="0123456789";u=s.length;while(q.length<6){q+=s.substr(Math.floor(Math.random()*u),1)}o=q+""+m.getMonth()+""+m.getDate()+""+m.getHours()}e.cookie.set(t,o)}return o}}i.prototype={_url:"https://"+(/changyoyo\.com/.test(document.domain)?"m.changyoyo.com":"test-m-stg.ppppoints.com")+"/wxservice/datacenter/ckd",_send:function(m){try{(new Image()).src=this._url+"?"+e.param(m)}catch(n){}},_sendInfo:function(s,r){var n=this,q={},p="login_token";r.action=="click"&&(r.action="02");q.useragent=b;q.jfmore=a.jfmore;q.browser=c+"_"+f+"_"+a.browser.version;q.domain=document.domain;q.iscookie=navigator.cookieEnabled?1:0;q.sid=n.getPVID();q.token=e.cookie.get(p)||"";q.eventType=r.action;q.remark=r.extend||"";q.preSiCode="";q.prePaCode="";q.preMoCode="";q.moCode=0;q.spm=0;q.siCode=n._getSiteCode();q.paCode=n._getPageCode()||0;if(r.action=="02"){q.moCode=s[3]||0;q.spm=s[4]||0}q.preurl=document.referrer||"";if(/00|01|page/.test(r.action)){d.length>0&&(q.preurl=d[d.length-1]);q.curUrl=r.url;var o=!q.preurl&&!d.length?"":q.preurl&&d.length>0?q.preurl:q.curUrl;q.preSiCode=e.getSiteCode(o);q.prePaCode=e.getPageCode(o);q.preMoCode=e.getPosCode(o);d.push(r.url)}else{d.length>1&&(q.preurl=d[d.length-2]);q.curUrl=d[d.length-1];q.preSiCode=e.getSiteCode(q.curUrl);q.prePaCode=e.getPageCode(q.curUrl);q.preMoCode=e.getPosCode(q.curUrl);!document.referrer&&d.length==1&&(q.preurl="")}q.curUrl=encodeURIComponent(q.curUrl);q.preurl=encodeURIComponent(q.preurl);n._send(q)},_domain:/changyoyo.com|ppppoints.com|jflm.com/,_data:["","","","","",""],_attr:{base:"data-spm",type:"data-spm-type",page:"data-spm-page",form:"data-spm-form",list:"data-spm-list",item:"data-spm-item",count:"data-spm-count"},_tmpl:{page:"{0}.{1}.{2}.0.0.{5}",form:"{0}.{1}.{2}.{3}.0.{5}",list:"{0}.{1}.{2}.{3}.0.{5}",item:"{0}.{1}.{2}.{3}.{4}.{5}"},_selector:{link:"a,area",button:"[data-spm]:not(a):not(area)"},_status:0,_initPage:function(){var o=this,n,q,p;n=e.get("body");q=e.get("meta[name="+o._attr.base+"]");o._setSiteCode(q?q.getAttribute("content"):"");o.setPageCode(n?n.getAttribute(o._attr.base):"");p=n?n.getAttribute(o._attr.page):"";if(o._data[0]==""){o.debug("warn","001","页面spm初始化失败： 请在页面<meta>中定义站点ID和站点类型")}else{if(o._data[1]==""){o.debug("warn","401","页面spm初始化失败： 请在页面<meta>或<body>中定义站点ID")}else{if(o._data[2]==""){o.debug("warn","100","页面spm初始化失败： 请在页面<body>中定义页面ID")}else{o._status=1;o.debug("info","100","页面初始化， spm = "+p)}}}},_bindEvent:function(){var D=this,z=window,J=document,I,A,G,q,B,r=350,F;var C=0,K=0,H=0,u=0,t=0,p=0,o=0,E=6,v;B="undefined";I="addEventListener";if(typeof(z.ontouchstart)!=B&&z.ontouchstart!=null){A="touchstart";G="touchend";q="touchmove";F=z}else{A="mousedown";G="mouseup";q="";F=J}F[I](A,function(m){C=new Date().getTime();if(m.touches&&m.touches[0]){u=m.touches[0].pageX;t=m.touches[0].pageY}D._execute(m,false);v=false},false);q&&F[I](q,function(m){v=true},false);F[I](G,function(m){K=new Date().getTime();if(m.touches&&m.touches[0]){p=m.touches[0].pageX;o=m.touches[0].pageY}if(v||K-C>=r){return}D._execute(m,true)},false)},_execute:function(r,s){var o=this,q=r.target,n,p;while(q&&q.tagName&&(n=q.tagName.toLowerCase())){p=[];if(/^(body|html)$/.test(n)){break}e.each(e.getDir(q,"parentNode"),function(){this.getAttribute(o._attr.base)&&p.push(this)});if(p.length&&(n=="a"||n=="area")){o._updateModContent(p[0])}else{if(p.length&&q.getAttribute(o._attr.base)){o._updateModContent(p[0])}else{if(n=="form"&&q.getAttribute(o._attr.base)){o._updateModContent(q)}else{if(q.getAttribute(o._attr.base)){o._updateItemContent(q)}}}}if(s&&q.getAttribute(o._attr.item)){o._addClickStat(q)}q=q.parentNode}},_addClickStat:function(p){var o,r,m,q,n;o=p.getAttribute(this._attr.item)||g;r=p.getAttribute("data-spm-action")||"02";m=p.getAttribute("data-spm-extend")||"";q=p.lastClickTime||0;n=new Date().getTime();if(o!=g&&n-q>600){this._trackEvent(o,r,m);p.lastClickTime=n}},_trackPageview:function(o){var n=this,p=[];if(o&&n.getQueryValue(o,k)){p=n.spmToArr(n.getQueryValue(o,k))}o=o||document.URL;try{n._sendInfo(p,{action:"00",extend:"",url:o});n.debug("info",208,"添加PV统计成功，spm = "+o)}catch(q){n.debug("warn",408,"添加PV统计失败，spm = "+o)}},_trackEvent:function(o,q,s){var n=this,p=n.spmToArr(o);if(p.length<4){p=n.setModuleCode(o)}try{n._sendInfo(p,{action:q,extend:s});n.debug("info",209,"添加点击统计成功，spm = "+o)}catch(r){n.debug("warn",409,"添加点击统计失败，spm = "+o)}},_updateItemContent:function(s){var p=this,o,n;var q=j,r="form";o=s.tagName.toLowerCase();n=s.getAttribute(p._attr.base);if(!n){return}o==r&&(q=r);p.setModuleCode(n,s,q);p.debug("info","元素初始化， spm = "+n)},_updateModContent:function(t){var p=this,o,n,s;var q=h,r="form";o=t.tagName.toLowerCase();n=t.getAttribute(p._attr.base);if(!n){return}p.debug("group","模块初始化， spm = "+n);p.debug("time","初始化耗时");o==r&&(q=r);s=p.setModuleCode(n,t,q);p._updateModLinks(t,s);p._updateModButtons(t,s);p.debug("timeEnd","初始化耗时");p.debug("groupEnd","模块初始化， spm = "+n)},_updateModLinks:function(r,q){var n=this,o,p=0;o=r.getAttribute(n._attr.type)||"child";r.removeAttribute(n._attr.type);if(o=="all"){e.each(r.querySelectorAll(n._selector.link),function(m){n._updateLink(this,q,m+1);p++})}else{if(o=="child"){e.each(r.children,function(m){if(/^(a|area)$/.test(this.tagName.toLowerCase())){n._updateLink(this,q,m+1);p++}})}}r.setAttribute(n._attr.count,p);n.debug("info",203,"共处理 "+p+" 个链接内容")},_updateModButtons:function(q,p){var n=this,o=0;e.each(q.querySelectorAll(n._selector.button),function(m){if(this.getAttribute(n._attr.item)){return}n.setElemItem(this,p,m+1);o++});q.setAttribute(n._attr.count,q.getAttribute(n._attr.count)+"|"+o);n.debug("info",204,"共处理 "+o+" 个按钮内容")},_updateLink:function(u,t,r,s){var p=this,q,o,n;if(u.getAttribute(p._attr.item)){return false}o=document.location.href;q=(u.getAttribute("href")||"").trim();if(!q||/^(#|javascript).?/i.test(q)||q==o){p.debug("info",403,"链接"+q+"不用处理");return false}n=u.getAttribute(p._attr.base);p.setElemItem(u,t,r,s);if(n==g){p.debug("info",403,"链接"+q+"已设置为不需要spm")}else{p.debug("info",403,"链接"+q+"已设置为不需要spm")}return true},_initDebug:function(){this.console=window&&window.console||{};if(!this.console.log){this.console.log=function(){}}if(!this.console.info){this.console.info=function(){}}if(!this.console.warn){this.console.warn=function(){}}if(!this.console.group){this.console.group=function(){}}if(!this.console.groupEnd){this.console.groupEnd=function(){}}if(!this.console.time){this.console.time=function(){}}if(!this.console.timeEnd){this.console.timeEnd=function(){}}},_setSiteCode:function(o){var n=this;o=n.spmToArr(o);o.length&&(n._data[0]=o.shift());o.length&&(n._data[1]=o.shift())},_getSiteCode:function(){return this.arrToSpm(this._data.slice(0,2))},_getPageCode:function(){return this._data[2]}};return new i()})();typeof exports==="object"&&typeof module!=="undefined"?module.exports=spm:typeof define==="function"&&define.amd?define(spm):(window.spm=spm);
