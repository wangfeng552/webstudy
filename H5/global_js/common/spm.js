var spm="object"==typeof spm?window.spm:function(){function v(){var b=this;return b instanceof v?(b.util=u,b.install=function(){var d,e,f,g,a=null,c=0;f=document,e=function(){a&&(clearInterval(a),a=null)},d=function(){f.body&&!b._status&&(g=f.createElement("meta"),g.setAttribute("content","always"),g.setAttribute("name","referrer"),f.head.appendChild(g),e(),b._initDebug(),b._initPage(),b._initSour(),b._bindEvent(),b._bindBack(),b._correctId(),b._status=1)},f.body?d():a=setInterval(function(){return c++>100?(e(),void 0):(d(),void 0)},20)},b.debug=function(a,c,d){b.debugMode&&b.console[a](d?c+" "+d:c)},b.setDebugOn=function(a){b.debugMode=a},b.setPageCode=function(a,c){var d,e=u.get("body");a=b.spmToArr(a),a.length&&(b._data[2]=a.pop()),a.length&&(b._data[1]=a.pop()),a.length&&(b._data[0]=a.pop()),b._data[3]="0",b._data[4]="0",b._data[5]=b.getPVID(),d=u.format(b._tmpl.page,b._data),e.setAttribute(b._attr.page,d),e.removeAttribute(b._attr.base),c&&(document.title=c)},b.getPageCode=function(){return b.arrToSpm(b._data)},b.setModuleCode=function(a,c,e){var h,i,f=b._data.slice(0);return a=b.spmToArr(a),a.length?(a.length&&(f[3]=a.pop()),a.length&&(f[2]=a.pop()),a.length&&(f[1]=a.pop()),a.length&&(f[0]=a.pop()),c&&(e=e||g,e==g&&(f[4]="0"),i=function(){h=u.format(b._tmpl[e],f),"form"==e&&(c.appendChild(u.createElem("input",{name:d,value:h,type:"hidden"})),c.action?c.action=b.addSpm(c.action,h):""),c.setAttribute(b._attr[e],h),c.removeAttribute(b._attr.base)},/^(a|area)$/.test(c.tagName.toLowerCase())?b._updateLink(c,f,0,"0")||i():i()),f):a},b.getModuleCode=function(a){var c=b._data.slice(0);return c[3]=a,b.arrToSpm(c)},b.getNumberCode=function(a){var c=b._data.slice(0);return a=b.spmToArr(a),a.length?(a.length&&(c[4]=a.pop()),a.length&&(c[3]=a.pop()),a.length&&(c[2]=a.pop()),a.length&&(c[1]=a.pop()),a.length&&(c[0]=a.pop()),b.arrToSpm(c)):a},b.setElemItem=function(a,c,d,e){var g,h,i="a";g=a.getAttribute(b._attr.base),c[4]=e||g||d,h=u.format(b._tmpl.item,c),g==f&&(h=f),a.setAttribute(b._attr.item,h),a.removeAttribute(b._attr.base),a.tagName.toLowerCase()==i&&h!=f&&a.setAttribute("href",b.addSpm(a.getAttribute("href"),h))},b.push=function(a){var c=a.shift();b.install(),b[c].apply(b,a)},b.refresh=function(a,b){"boolean"==typeof a&&(b=a,a=""),!a&&(a=document.location.href),a.indexOf(d+"=")<0&&(a=this.addSpm(a,this._data.join(e))),b?location.replace(a):document.location.href=a},b.arrToSpm=function(a){return(a||[]).join(e)},b.spmToArr=function(a){return((a||"")+"").split(e)},b.sliceBefore=function(a,b){return a.indexOf(b)>=0?a.substring(0,a.indexOf(b)):""},b.sliceAfter=function(a,b){return a.indexOf(b)>=0?a.substring(a.indexOf(b)+b.length,a.length):""},b.getQueryValue=u.getQueryValue,b.addSpm=function(a,c){var f,e="";return c=c||b.getPageCode(),f=b.getQueryValue(a,d),f?a=a.replace(f,c):(e=b.sliceAfter(a,"#"),e&&(e="#"+e,a=b.sliceBefore(a,"#")),a+=(a.indexOf("?")>0?"&":"?")+d+"="+c),a+e},b.getSource=function(){var e,g,h,b=this,f=[];return b.getPVID(),e=u.cookie.get(b._SOURKEY),g=u.get("meta[name="+c+"]"),(b._IS_NEW_PVKEY&&!e||g)&&(h=g?g.getAttribute("content"):"",f=b.spmToArr(b.getQueryValue(d)),e=h||b.getQueryValue(c)||f[6]||"",e&&u.cookie.set(b._SOURKEY,e)),!e&&m&&u.cookie.set(b._SOURKEY,m),e=e||m,m=e||"",e||a},b.getLastSource=function(){var h,b=this,e=u.cookie.get(b._LASTSOURKEY),f=u.get("meta[name="+c+"]"),g=function(){var e,a=[];return e=f?f.getAttribute("content"):"",a=b.spmToArr(b.getQueryValue(d)),e||b.getQueryValue(c)||a[6]||""};return(!e||f)&&(e=g(),e&&u.cookie.set(b._LASTSOURKEY,e)),!e&&p&&u.cookie.set(b._LASTSOURKEY,p),e=e||p,p=e||"",h=g(),h&&h!=p&&h!=m&&h!=a&&(u.cookie.set(b._LASTSOURKEY,h),p=h,e=h),e||a},b.getParam=function(){var b,a=this,d="param";return b=u.cookie.get(d),meta=u.get("meta[name="+d+"]"),meta&&(b=meta.getAttribute("content")||"",b?(b+="&"+c+":"+a.getSource(),u.cookie.set(d,b)):o="",meta.parentNode.removeChild(meta)),!b&&o&&(b=o,u.cookie.set(d,b)),o=b||"",b||""},b.getPVID=function(){var c,e,f,g,h,a=this,b=u.cookie.get(a._PVKEY);if(!b){if(a._IS_NEW_PVKEY=!0,a._domain.test(n)?(h=a.spmToArr(a.getQueryValue(d)),b=h[5]||""):t.jfmore&&(h=a.spmToArr(a.getQueryValue(d)),b=h[5]||""),b=b||l,!b){for(c=new Date,e="",f="0123456789",g=f.length;e.length<6;)e+=f.substr(Math.floor(Math.random()*g),1);b=e+""+c.getMonth()+c.getDate()+c.getHours()}u.cookie.set(a._PVKEY,b)}return l=b,b},void 0):new v}var k,l,m,o,p,a=["0","20","0","00","00"].join(""),b=["m",".","ch","angyo","y","o",".","c","o","m"].join(""),c=["ch","a","n","n","e","l_s","o","u","rce"].join(""),d="spm",e=".",f="no",g="item",h="list",i=[],j=[],n=document.referrer,q=navigator.userAgent,t={jfmore:/_jfmore_(\d\.\d\.\d)/.test(q)?/android/i.test(q)?"android":"ios":"",inIos:!!q.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),inAndroid:/(android)/i.test(q),inPc:!/Android|webOS|iphone|ipod|ipad|BlackBerry/i.test(q),inWeixin:!!q.match(/micromessenger/i),browser:{version:(q.match(/.+(?:rv|it|ra|ie)[\/: ]([\d.]+)/)||[0,"0"])[1],safari:/webkit/i.test(q),uc:/Linux/i.test(q),opera:/opera/i.test(q),msie:/msie/i.test(q)&&!/opera/.test(q),mozilla:/mozilla/i.test(q)&&!/(compatible|webkit)/i.test(q)}},r=function(){var a="";return t.jfmore?a=t.jfmore:t.inWeixin?a="weixin":t.inPc?a="pc":t.inIos?a="ios-h5":t.inAndroid&&(a="android-h5"),a}(),s=function(){var c,a="",b=t.browser;for(c in b)if(b[c]&&b.hasOwnProperty(c)&&"version"!=c){a=c;break}return a}(),u={get:function(a){return"object"==typeof a?a:document.querySelector(a)},getAll:function(a){return"object"==typeof a?a:document.querySelectorAll(a)},getDir:function(a,b){for(var c=[],d=a[b];d&&d!=document;)1==d.nodeType&&c.push(d),d=d[b];return c},createElem:function(a,b){a=document.createElement(a);for(var c in b)a[c]=b[c];return a},isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)},format:function(a){if(arguments.length>1){var b=2==arguments.length&&this.isArray(arguments[1])?arguments[1]:this.makeArray(arguments).slice(1);this.each(b,function(b,c){c=void 0==c?"":c,a=a.replace(new RegExp("\\{"+b+"\\}","g"),c)})}return a},makeArray:function(a){for(var b=[],c=a.length;c;)b[--c]=a[c];return b},each:function(a,b){a=a||[];for(var c=0,d=a.length;d>c&&0!=b.call(a[c],c,a[c]);c++);},param:function(a){var c,b=[];for(c in a||{})a.hasOwnProperty(c)&&b.push(c+"="+a[c]);return b.join("&")},cookie:{set:function(a,b,c){var d,e,f,g,h;c=c||{},null===b&&(b="",c=$.extend({},c),c.expires=-1),d="",c.expires&&("number"==typeof c.expires||c.expires.toUTCString)&&("number"==typeof c.expires?(e=new Date,e.setTime(e.getTime()+1e3*60*60*24*c.expires)):e=c.expires,d="; expires="+e.toUTCString()),c.path=c.path||"/",f=c.path?"; path="+c.path:"",g=c.domain?"; domain="+c.domain:"",h=c.secure?"; secure":"",document.cookie=[a,"=",encodeURIComponent(b),d,f,g,h].join("")},get:function(a){var c,d,e,b=null;if(document.cookie&&""!=document.cookie)for(c=document.cookie.split(";"),d=0;d<c.length;d++)if(e=(c[d]||"").replace(/^\s+|\s+$/g,""),e.substring(0,a.length+1)==a+"="){b=decodeURIComponent(e.substring(a.length+1));break}return b}},getQueryValue:function(a,b){var c,d;return b||(b=a,a=location.href+""),c=new RegExp("(^|&|\\?|#)"+b+"=([^&]*)(&|$)",""),d=a.match(c),(d&&d[2]||"").trim().split("#")[0]},getSiteCode:function(a){var b,c,f="";return b=this.getQueryValue(a||"",d),c=b.split(e),""!=c[0]&&""!=c[1]&&(f=c.slice(0,2).join(e)),f},getPageCode:function(a){var b,c;return b=this.getQueryValue(a||"",d),c=b.split(e),c[2]||""},getPosCode:function(a){var b,c;return b=this.getQueryValue(a||"",d),c=b.split(e),c[3]||""}};return v.prototype={_stSid:null,_status:0,_IS_NEW_PVKEY:!1,_PVKEY:["","PU","V",""].join("_"),_SOURKEY:["SO","UR","C","E"].join("_"),_LASTSOURKEY:["LA","STSO","UR","C","E"].join("_"),_url:"https://"+(document.domain==b?"m.changyoyo.com/notify":"test-m-stg.ppppoints.com/wxservice")+"/datacenter/ckd",_send:function(a){try{(new Image).src=this._url+"?"+u.param(a)}catch(b){}},_sendInfo:function(a,b){var c=this,d={},e="login_token";if("click"==b.action&&(b.action="02"),d.useragent=q,d.jfmore=t.jfmore,d.browser=r+"_"+s+"_"+t.browser.version,d.domain=document.domain,d.iscookie=navigator.cookieEnabled?1:0,d.sid=c.getPVID(),d.token=u.cookie.get(e)||"",d.eventType=b.action,d.remark=b.extend||"",d.preSiCode="",d.prePaCode="",d.preMoCode="",d.moCode=0,d.spm=0,d.siCode=c._getSiteCode(),d.paCode=c._getPageCode()||0,d.source=c.getSource(),d.reserve=document.title||"","02"==b.action&&(d.moCode=a[3]||0,d.spm=a[4]||0),d.time="",d.preurl=n||"",/00|01|page/.test(b.action)){if(i.length>0&&(d.preurl=i[i.length-1]),d.curUrl=b.url,d.preSiCode=u.getSiteCode(d.curUrl),d.prePaCode=u.getPageCode(d.curUrl),d.preMoCode=u.getPosCode(d.curUrl),c._removeSpm(b.url)==c._removeSpm(i[i.length-1]))return;i.push(b.url),j.push(spm.addSpm(b.url)),k=(new Date).getTime()}else i.length>1&&(d.preurl=i[i.length-2]),d.curUrl=i[i.length-1],d.preSiCode=u.getSiteCode(d.curUrl),d.prePaCode=u.getPageCode(d.curUrl),d.preMoCode=u.getPosCode(d.curUrl),!n&&1==i.length&&(d.preurl=""),d.time=(new Date).getTime()-k;d.curUrl=encodeURIComponent(d.curUrl),d.preurl=encodeURIComponent(d.preurl),c._send(d)},_domain:RegExp(["ch","a","ng","y","oy","o",".c","o","m|","p","p","pp","o","in","t","s",".c","o","m","|j","flm",".","co","m"].join("")),_data:["","","","","",""],_attr:{base:"data-spm",type:"data-spm-type",page:"data-spm-page",form:"data-spm-form",list:"data-spm-list",item:"data-spm-item",count:"data-spm-count"},_tmpl:{page:"{0}.{1}.{2}.0.0.{5}",form:"{0}.{1}.{2}.{3}.0.{5}",list:"{0}.{1}.{2}.{3}.0.{5}",item:"{0}.{1}.{2}.{3}.{4}.{5}"},_selector:{link:"a,area",button:"[data-spm]:not(a):not(area)"},_status:0,_initPage:function(){var b,c,d,a=this;b=u.get("body"),c=u.get("meta[name="+a._attr.base+"]"),a._setSiteCode(c?c.getAttribute("content"):"3.1"),a.setPageCode(b?b.getAttribute(a._attr.base):""),d=b?b.getAttribute(a._attr.page):"",""==a._data[0]?a.debug("warn","001","页面spm初始化失败： 请在页面<meta>中定义站点ID和站点类型"):""==a._data[1]?a.debug("warn","401","页面spm初始化失败： 请在页面<meta>或<body>中定义站点ID"):""==a._data[2]?a.debug("warn","100","页面spm初始化失败： 请在页面<body>中定义页面ID"):a.debug("info","100","页面初始化， spm = "+d)},_initSour:function(){var c,a=this,b=a.getSource();for(c in a._tmpl)a._tmpl.hasOwnProperty(c)&&(a._tmpl[c]=a._tmpl[c]+"."+b);a._data[6]=b},_bindEvent:function(){var e,f,g,j,k,t,a=this,b=window,c=document,i=350,l=0,m=0,o=0,p=0,q=0,r=0,h="undefined",d="addEventListener";typeof b.ontouchstart!=h&&null!=b.ontouchstart?(e="touchstart",f="touchend",g="touchmove",j=b):(e="mousedown",f="mouseup",g="",j=c),j[d](e,function(b){l=(new Date).getTime(),b.touches&&b.touches[0]&&(o=b.touches[0].pageX,p=b.touches[0].pageY),a._execute(b,!1),t=!1,k=b},!1),g&&j[d](g,function(){t=!0},!1),j[d](f,function(b){m=(new Date).getTime(),b.touches&&b.touches[0]&&(q=b.touches[0].pageX,r=b.touches[0].pageY),t||m-l>=i||a._execute(k,!0)},!1)},_bindBack:function(){var a=history.go;history.go=function(){j.length&&i.push(j.pop()),a.apply(history,arguments)}},_correctId:function(){var a=this,b=function(){a.getSource(),a.getParam(),a._stSid=setTimeout(function(){b()},2e3)};clearTimeout(a._stSid),b()},_execute:function(a,b){for(var e,f,c=this,d=a.target;d&&d.tagName&&(e=d.tagName.toLowerCase())&&(f=[],!/^(body|html)$/.test(e));)u.each(u.getDir(d,"parentNode"),function(){this.getAttribute(c._attr.base)&&f.push(this)}),!f.length||"a"!=e&&"area"!=e?f.length&&d.getAttribute(c._attr.base)?c._updateModContent(f[0]):"form"==e&&d.getAttribute(c._attr.base)?c._updateModContent(d):d.getAttribute(c._attr.base)&&c._updateItemContent(d):c._updateModContent(f[0]),b&&(d.getAttribute(c._attr.item)?c._addClickStat(d):("a"==e||"area"==e)&&(c._updateLink(d,c._data,0),c._addClickStat(d))),d=d.parentNode},_addClickStat:function(a){var b,c,d,e,g;b=a.getAttribute(this._attr.item)||f,c=a.getAttribute("data-spm-action")||"02",d=a.getAttribute("data-spm-extend")||"",e=a.lastClickTime||0,g=(new Date).getTime(),b!=f&&g-e>600&&(this._trackEvent(b,c,d),a.lastClickTime=g)},_trackPageview:function(a){var b=this,c=[];!i.length&&(a=document.URL),a&&b.getQueryValue(a,d)&&(c=b.spmToArr(b.getQueryValue(a,d))),a=a||document.URL;try{b._sendInfo(c,{action:"00",extend:"",url:a}),b.debug("info",208,"添加PV统计成功，spm = "+a)}catch(e){b.debug("warn",408,"添加PV统计失败，spm = "+a)}},_trackEvent:function(a,b,c){var d=this,e=d.spmToArr(a);e.length<4&&(e=d.setModuleCode(a));try{d._sendInfo(e,{action:b,extend:c}),d.debug("info",209,"添加点击统计成功，spm = "+a)}catch(f){d.debug("warn",409,"添加点击统计失败，spm = "+a)}},_updateItemContent:function(a){var b=this,e=g,f="form",c=a.tagName.toLowerCase(),d=a.getAttribute(b._attr.base);d&&(c==f&&(e=f),b.setModuleCode(d,a,e),b.debug("info","元素初始化， spm = "+d))},_updateModContent:function(a){var e,b=this,f=h,g="form",c=a.tagName.toLowerCase(),d=a.getAttribute(b._attr.base);d&&(b.debug("group","模块初始化， spm = "+d),b.debug("time","初始化耗时"),c==g&&(f=g),e=b.setModuleCode(d,a,f),b._updateModLinks(a,e),b._updateModButtons(a,e),b.debug("timeEnd","初始化耗时"),b.debug("groupEnd","模块初始化， spm = "+d))},_updateModLinks:function(a,b){var d,c=this,e=0;d=a.getAttribute(c._attr.type)||"child",a.removeAttribute(c._attr.type),"all"==d?u.each(a.querySelectorAll(c._selector.link),function(a){c._updateLink(this,b,a+1),e++}):"child"==d&&u.each(a.children,function(a){/^(a|area)$/.test(this.tagName.toLowerCase())&&(c._updateLink(this,b,a+1),e++)}),a.setAttribute(c._attr.count,e),c.debug("info",203,"共处理 "+e+" 个链接内容")},_updateModButtons:function(a,b){var c=this,d=0;u.each(a.querySelectorAll(c._selector.button),function(a){this.getAttribute(c._attr.item)||(c.setElemItem(this,b,a+1),d++)}),a.setAttribute(c._attr.count,a.getAttribute(c._attr.count)+"|"+d),c.debug("info",204,"共处理 "+d+" 个按钮内容")},_updateLink:function(a,b,c,d){var g,h,i,e=this;return a.getAttribute(e._attr.item)?!1:(h=document.location.href,g=(a.getAttribute("href")||"").trim(),!g||/^(#|javascript).?/i.test(g)||g==h?(e.debug("info",403,"链接"+g+"不用处理"),!1):(i=a.getAttribute(e._attr.base),e.setElemItem(a,b,c,d),i==f&&e.debug("info",403,"链接"+g+"已设置为不需要spm"),!0))},_initDebug:function(){this.console=window&&window.console||{},this.console.log||(this.console.log=function(){}),this.console.info||(this.console.info=function(){}),this.console.warn||(this.console.warn=function(){}),this.console.group||(this.console.group=function(){}),this.console.groupEnd||(this.console.groupEnd=function(){}),this.console.time||(this.console.time=function(){}),this.console.timeEnd||(this.console.timeEnd=function(){})},_setSiteCode:function(a){var b=this;a=b.spmToArr(a),a.length&&(b._data[0]=a.shift()),a.length&&(b._data[1]=a.shift())},_getSiteCode:function(){return this.arrToSpm(this._data.slice(0,2))},_getPageCode:function(){return this._data[2]},_removeSpm:function(a){var c,e,f,b=this;return a=a||"",(c=b.sliceBefore(a,"?"))?(e=b.sliceAfter(a,"?"),f=b.getQueryValue(a,d),e=e.replace(d+"="+f,""),c+e):a},_reset:function(){var a=this;clearTimeout(a._stSid),m=null,p=null,u.cookie.set("param",""),u.cookie.set(a._PVKEY,""),u.cookie.set(a._SOURKEY,""),u.cookie.set(a._LASTSOURKEY,"")}},new v}();"object"==typeof exports&&"undefined"!=typeof module?module.exports=spm:"function"==typeof define&&define.amd?define(spm):window.spm=spm,spm.install();